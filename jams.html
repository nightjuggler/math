<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Julia and Mandelbrot Set Explorer</title>
<style>
body {
	background-color: white;
	font-family: verdana;
	font-size: 12pt;
}
a {
	text-decoration: none;
}
input {
	font-family: verdana;
	font-size: 12pt;
	margin-top: 2px;
	margin-bottom: 2px;
}
#canvas {
	border: 4px solid black;
	cursor: pointer;
}
#controlDiv {
	background-color: rgba(230,230,250,0.8);
	border: 2px solid black;
	border-radius: 10px;
	text-align: center;
	width: 520px;
	padding: 2px;
	position: relative;
}
#paramTable td {
	text-align: left;
}
#paramTable td:first-child {
	text-align: right;
}
#examples ul {
	margin-top: 0;
}
@keyframes spinDiscAnimation {
	from { transform: rotateZ(0deg); }
	to { transform: rotateZ(360deg); }
}
#spinDisc {
	display: none;
	position: absolute;
	top: 35%;
	left: 50%;
	width: 0px;
	height: 0px;

	border-top: 20px solid rgb(65,105,225); /* RoyalBlue */
	border-left: 20px solid rgb(135,206,250); /* LightSkyBlue */
	border-bottom: 20px solid rgb(65,105,225); /* RoyalBlue */
	border-right: 20px solid rgb(135,206,250); /* LightSkyBlue */
	border-radius: 20px;

	animation-name: spinDiscAnimation;
	animation-duration: 1.0s;
	animation-iteration-count: infinite;
	animation-timing-function: linear;
	animation-play-state: paused;
}
</style>
<script>
/* globals document, window */
/* globals HTMLInputElement, HTMLSelectElement */
(function() {
"use strict";
const global = {
	centerX: -0.6,
	centerY: 0,
	width: 3,
	zoom: 2,
	maxIteration: 256,
	pixelShift: 50,
	isJulia: false,
	constantX: 0,
	constantY: 0,
	kernel: [0, 1, 0, 1, 2, 1, 0, 1, 0],
	clickTimeout: 0,
	drawing: false,
};
function inSet(zx, zy, cx, cy, n)
{
	zx += cx;
	zy += cy;

	var i = 0;
	var zx2 = zx*zx;
	var zy2 = zy*zy;

	while (zx2 + zy2 <= 4)
	{
		if (++i === n)
			return null;

		zy = cy + 2*zx*zy;
		zx = cx + zx2 - zy2;

		zx2 = zx*zx;
		zy2 = zy*zy;
	}

//	i += 1 - Math.log(Math.log(zx2 + zy2)) / Math.LN2;
	return i;
}
/*
function setRGBfromHSV(d, i, h, s, v)
{
	h /= 60;

	var c = v * s;
	var m = v - c;
	var x = c * (1 - Math.abs(h % 2 - 1));

	var r, g, b;

	if (h < 1) {
		r = c; g = x; b = 0;
	} else if (h < 2) {
		r = x; g = c; b = 0;
	} else if (h < 3) {
		r = 0; g = c; b = x;
	} else if (h < 4) {
		r = 0; g = x; b = c;
	} else if (h < 5) {
		r = x; g = 0; b = c;
	} else {
		r = c; g = 0; b = x;
	}

	d[i  ] = 255 * (r + m);
	d[i+1] = 255 * (g + m);
	d[i+2] = 255 * (b + m);
	d[i+3] = 255;
}
*/
function setRGB(d, i, iterationCount)
{
	if (iterationCount === null) {
		d[i  ] = 0;
		d[i+1] = 0;
		d[i+2] = 0;
		d[i+3] = 255;
		return;
	}

	var h = (280 + iterationCount) % 360 / 60;
	var x = 1 - Math.abs(h % 2 - 1);

	var r, g, b;

	if (h < 1) {
		r = 1; g = x; b = 0;
	} else if (h < 2) {
		r = x; g = 1; b = 0;
	} else if (h < 3) {
		r = 0; g = 1; b = x;
	} else if (h < 4) {
		r = 0; g = x; b = 1;
	} else if (h < 5) {
		r = x; g = 0; b = 1;
	} else {
		r = 1; g = 0; b = x;
	}

	d[i  ] = 255 * r;
	d[i+1] = 255 * g;
	d[i+2] = 255 * b;
	d[i+3] = 255;
}
function computeJulia(imageData, minX, maxY)
{
	var d = imageData.data;
	var w = imageData.width;
	var h = imageData.height;

	var i = 0;
	var n = global.maxIteration;
	var cx = global.constantX;
	var cy = global.constantY;
	var step = global.width / (w - 1);

	for (var y = h, zy = maxY; y !== 0; y -= 1, zy -= step)
		for (var x = w, zx = minX; x !== 0; x -= 1, zx += step, i += 4)
			setRGB(d, i, inSet(zx, zy, cx, cy, n));
}
function computeMandelbrot(imageData, minX, maxY)
{
	var d = imageData.data;
	var w = imageData.width;
	var h = imageData.height;

	var i = 0;
	var n = global.maxIteration;
	var step = global.width / (w - 1);

	for (var y = h, zy = maxY; y !== 0; y -= 1, zy -= step)
		for (var x = w, zx = minX; x !== 0; x -= 1, zx += step, i += 4)
			setRGB(d, i, inSet(0, 0, zx, zy, n));
}
function convolve3x3(context, inData, channels, kernel, abs)
{
	var setR = (channels & 1) === 1;
	var setG = (channels & 2) === 2;
	var setB = (channels & 4) === 4;

	var outData = context.createImageData(inData);
	var s = inData.data;
	var d = outData.data;

	var width = inData.width;
	var height = inData.height;

	var sumOfWeights = 0;
	for (var weight of kernel)
		sumOfWeights += weight;
	if (sumOfWeights === 0)
		sumOfWeights = 1;

	// edgeMode is 'duplicate'

	var yDelta = width * 4;
	var i0, i1, i2, i3, i5, i6, i7, i8;

	var k0 = kernel[0], k1 = kernel[1], k2 = kernel[2];
	var k3 = kernel[3], k4 = kernel[4], k5 = kernel[5];
	var k6 = kernel[6], k7 = kernel[7], k8 = kernel[8];

	var i = 0;
	for (var y = 0; y < height; ++y)
	{
		var yUp = y === 0 ? 0 : -yDelta;
		var yDn = y === height - 1 ? 0 : yDelta;

		for (var x = 0; x < width; ++x)
		{
			var xLft = x === 0 ? 0 : -4;
			var xRgt = x === width - 1 ? 0 : 4;
/*
	"The values in the kernel matrix are applied such that the kernel matrix is rotated 180 degrees
	relative to the source and destination images in order to match convolution theory as described
	in many computer graphics textbooks."
	(https://www.w3.org/TR/filter-effects-1/#feConvolveMatrixElement)
*/
			// 8 7 6
			// 5 4 3
			// 2 1 0

			i7 = i + yUp;
			i8 = i7 + xLft;
			i6 = i7 + xRgt;
			i5 = i + xLft;
			i3 = i + xRgt;
			i1 = i + yDn;
			i2 = i1 + xLft;
			i0 = i1 + xRgt;

			var r = k8*s[i8] + k7*s[i7] + k6*s[i6] +
				k5*s[i5] + k4*s[i ] + k3*s[i3] +
				k2*s[i2] + k1*s[i1] + k0*s[i0];
			var g = k8*s[i8+1] + k7*s[i7+1] + k6*s[i6+1] +
				k5*s[i5+1] + k4*s[i +1] + k3*s[i3+1] +
				k2*s[i2+1] + k1*s[i1+1] + k0*s[i0+1];
			var b = k8*s[i8+2] + k7*s[i7+2] + k6*s[i6+2] +
				k5*s[i5+2] + k4*s[i +2] + k3*s[i3+2] +
				k2*s[i2+2] + k1*s[i1+2] + k0*s[i0+2];
			if (sumOfWeights !== 1) {
				r /= sumOfWeights;
				g /= sumOfWeights;
				b /= sumOfWeights;
			}
			if (abs) {
				r = Math.abs(r);
				g = Math.abs(g);
				b = Math.abs(b);
			}
			d[i  ] = setR ? r : s[i  ];
			d[i+1] = setG ? g : s[i+1];
			d[i+2] = setB ? b : s[i+2];
			d[i+3] = s[i+3];
			i += 4;
		}
	}

	return outData;
}
function computeFractal()
{
	var minX = global.centerX - global.width / 2;
	var maxY = global.centerY + global.width / 2 / global.widthHeightRatio;

	var imageData = global.context.createImageData(global.canvas.width, global.canvas.height);

	(global.isJulia ? computeJulia : computeMandelbrot)(imageData, minX, maxY);

	imageData = convolve3x3(global.context, imageData, 7, global.kernel, false);
	global.context.putImageData(imageData, 0, 0);

	var spinDisc = document.getElementById("spinDisc");
	spinDisc.style.animationPlayState = "paused";
	spinDisc.style.display = "none";

	global.drawing = false;
}
function draw()
{
	var spinDisc = document.getElementById("spinDisc");
	spinDisc.style.animationPlayState = "running";
	spinDisc.style.display = "block";

	global.clickTimeout = 0;
	global.drawing = true;

	window.setTimeout(computeFractal, 20);
}
function redraw(event)
{
	draw();
	event.preventDefault();
	event.stopPropagation();
	return false;
}
function setCenter(event)
{
	var c = global.canvas;
	var x = event.clientX - c.clientLeft - c.offsetLeft + window.scrollX;
	var y = event.clientY - c.clientTop - c.offsetTop + window.scrollY;

	global.centerX += global.width * (x/c.width - 0.5);
	global.centerY += global.width / global.widthHeightRatio * (0.5 - y/c.height);
}
function zoomIn()
{
	global.width /= global.zoom;
	document.getElementById("widthField").value = global.width;
}
function zoomOut()
{
	global.width *= global.zoom;
	document.getElementById("widthField").value = global.width;
}
function canvasClick(event)
{
	event.preventDefault();
	event.stopPropagation();

	if (global.drawing)
		return false;
	if (global.clickTimeout === 0) {
		setCenter(event);
		global.clickTimeout = window.setTimeout(draw, 500);
	} else {
		window.clearTimeout(global.clickTimeout);
		zoomIn();
		draw();
	}
	return false;
}
function documentKeyDown(event)
{
	if (event.target instanceof HTMLInputElement ||
		event.target instanceof HTMLSelectElement) return true;

	switch (event.key)
	{
	case "i":
	case "U+0049":
		zoomIn();
		break;
	case "o":
	case "U+004F":
		zoomOut();
		break;
	case "ArrowLeft":
		global.centerX -= global.width * global.pixelShift / global.canvas.width;
		break;
	case "ArrowRight":
		global.centerX += global.width * global.pixelShift / global.canvas.width;
		break;
	case "ArrowDown":
		global.centerY -= global.width * global.pixelShift / global.canvas.width;
		break;
	case "ArrowUp":
		global.centerY += global.width * global.pixelShift / global.canvas.width;
		break;
	default:
		return true;
	}

	return redraw(event);
}
const _parseFloat = v =>
	/^-?(?:0|[1-9][0-9]{0,2})(?:\.[0-9]{1,15})?$/.test(v) ? parseFloat(v) : null;
function parseXY(v, name)
{
	if ((v = v.split(",")).length !== 2) return;
	let [x, y] = v;
	if ((x = _parseFloat(x)) === null) return;
	if ((y = _parseFloat(y)) === null) return;
	global[name + "X"] = x;
	global[name + "Y"] = y;
}
function parseCenter(v)
{
	parseXY(v, "center");
}
function parseConstant(v)
{
	global.isJulia = true;
	parseXY(v, "constant");
}
function parseMaxIteration(v)
{
	if (v.length <= 5 && /^[1-9][0-9]*$/.test(v))
		global.maxIteration = parseInt(v, 10);
}
function parseWidth(v)
{
	if ((v = _parseFloat(v)) !== null && v > 0)
		global.width = v;
}
function parseZoom(v)
{
	if (/^[1-9][0-9]?(?:\.[0-9]{1,2})?$/.test(v))
		global.zoom = parseFloat(v);
}
function parseQueryString(handlers)
{
	const q = window.location.search;

	if (typeof q !== "string" || q.charAt(0) !== "?") return;

	for (const s of q.substring(1).split("&"))
	{
		const i = s.indexOf("=");
		const [key, val] = i < 0 ? [s, ""] : [s.substring(0, i), s.substring(i + 1)];

		if (key.length <= 1 && /^[a-z]+$/.test(key) && handlers.hasOwnProperty(key))
			handlers[key](val);
	}
}
function init()
{
	global.canvas = document.getElementById("canvas");
	global.context = global.canvas.getContext("2d");
	global.widthHeightRatio = global.canvas.width / global.canvas.height;

	parseQueryString({
		c: parseConstant,
		i: parseMaxIteration,
		o: parseCenter,
		w: parseWidth,
		z: parseZoom,
	});

	switch (9)
	{
	case 1:
		global.isJulia = false;
		global.centerX = -1.2025;
		global.centerY = -0.1617;
		global.width = 0.005;
		global.maxIteration = 512;
		break;
	case 2:
		global.isJulia = false;
		global.centerX = -1.768573656315;
		global.centerY = -0.000964296851;
		global.width = 0.000001;
		global.maxIteration = 4096;
		break;
	case 3:
		global.isJulia = true;
		global.constantX = -0.7269;
		global.constantY = 0.1889;
		global.centerX = 0.725;
		global.centerY = -0.2;
		global.width = 3.05;
		global.maxIteration = 1024;
		break;
	case 4:
		global.isJulia = true;
		global.constantX = -0.4;
		global.constantY = 0.6;
		global.centerX = 0.4;
		global.centerY = -0.6;
		global.width = 3.12;
		global.maxIteration = 512;
		break;
	case 5:
		global.isJulia = true;
		global.constantX = -0.8;
		global.constantY = 0.156;
		global.centerX = 0.8;
		global.centerY = -0.16;
		global.width = 3.2;
		global.maxIteration = 512;
		break;
	case 6:
		global.isJulia = true;
		global.constantX = -0.835;
		global.constantY = -0.2321;
		global.centerX = 0.85;
		global.centerY = 0.2;
		global.width = 3.3;
		global.maxIteration = 256;
		break;
	case 7:
		global.isJulia = true;
		global.constantX = 0.285;
		global.constantY = 0.01;
		global.centerX = -0.25;
		global.centerY = -0.0167;
		global.width = 3.5;
		global.maxIteration = 256;
		break;
	case 8:
		global.isJulia = true;
		global.constantX = -0.214;
		global.constantY = 0.789;
		global.centerX = 0.25;
		global.centerY = -0.767;
		global.width = 3.5;
		global.maxIteration = 256;
		break;
	}

	draw();

	document.getElementById("centerX").value = global.centerX;
	document.getElementById("centerY").value = global.centerY;
	document.getElementById("constantX").value = global.constantX;
	document.getElementById("constantY").value = global.constantY;
	document.getElementById("widthField").value = global.width;
	document.getElementById("maxIterationField").value = global.maxIteration;

	global.canvas.addEventListener("click", canvasClick);
	document.addEventListener("keydown", documentKeyDown);
}
window.addEventListener("DOMContentLoaded", init);
})();
</script>
</head>
<body>

<canvas id="canvas" width="900" height="600"></canvas>

<ul>
<li>Click to set the center.
<li>Double click to set the center and zoom in.
<li>Press &quot;i&quot; to zoom in.
<li>Press &quot;o&quot; to zoom out.
<li>Use the arrow keys to move 50 pixels left, right, up, or down.
</ul>

<div id="examples">Examples:
<ul>
<li><a href="jams.html?o=-1.2025,-0.1617&w=0.005&i=512">Mandelbrot set:
	center=-1.2025,-0.1617 / width=0.005 / maxIteration=512</a>

<li><a href="jams.html?o=-1.768573656315,-0.000964296851&w=0.000001&i=4096">Mandelbrot set:
	center=-1.768573656315,-0.000964296851 / width=0.000001 / maxIteration=4096</a>

<li><a href="jams.html?c=-0.7269,0.1889&o=0.725,-0.2&w=3.05&i=1024">Julia set:
	constant=-0.7269,0.1889 / center=0.725,-0.2 / width=3.05 / maxIteration=1024</a>

<li><a href="jams.html?c=-0.4,0.6&o=0.4,-0.6&w=3.12&i=512">Julia set:
	constant=-0.4,0.6 / center=0.4,-0.6 / width=3.12 / maxIteration=512</a>

<li><a href="jams.html?c=-0.8,0.156&o=0.8,-0.16&w=3.2&i=512">Julia set:
	constant=-0.8,0.156 / center=0.8,-0.16 / width=3.2 / maxIteration=512</a>

<li><a href="jams.html?c=-0.835,-0.2321&o=0.85,0.2&w=3.3&i=256">Julia set:
	constant=-0.835,-0.2321 / center=0.85,0.2 / width=3.3 / maxIteration=256</a>

<li><a href="jams.html?c=0.285,0.01&o=-0.25,-0.0167&w=3.5&i=256">Julia set:
	constant=0.285,0.01 / center=-0.25,-0.0167 / width=3.5 / maxIteration=256</a>

<li><a href="jams.html?c=-0.214,0.789&o=0.25,-0.767&w=3.5&i=256">Julia set:
	constant=-0.214,0.789 / center=0.25,-0.767 / width=3.5 / maxIteration=256</a>
</ul>
</div>

<div id="controlDiv">
<table id="paramTable">
<tr>
<td>Constant:</td>
<td>
<input type="text" id="constantX" size="20" disabled />,
<input type="text" id="constantY" size="20" disabled /></td>
</tr>
<tr>
<td>Center:</td>
<td>
<input type="text" id="centerX" size="20" disabled />,
<input type="text" id="centerY" size="20" disabled /></td>
</tr>
<tr>
<td>Width:</td>
<td><input type="text" id="widthField" size="20" disabled /></td>
</tr>
<tr>
<td>Max Iteration:</td>
<td><input type="text" id="maxIterationField" size="5" disabled /></td>
</tr>
</table>
<div id="spinDisc"></div>
</div>

</body>
</html>
